parameters:
  - name: environment
    type: string
  - name: databricksHost
    type: string
  - name: databricksToken
    type: string

steps:
  - task: PowerShell@2
    displayName: 'Discover and Run Tests'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "============================================================"
        Write-Host "  Running Tests in ${{ parameters.environment }}"
        Write-Host "============================================================"
        
        $headers = @{
          Authorization = "Bearer ${{ parameters.databricksToken }}"
          "Content-Type" = "application/json"
        }
        
        # Discover pipelines from Databricks Tests folder
        Write-Host "`nüìã Discovering test pipelines from Databricks..."
        
        try {
          $testsPath = [uri]::EscapeDataString("/Workspace/Shared/Tests/pipelines")
          $testsFolders = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.0/workspace/list?path=$testsPath" `
            -Headers $headers `
            -Method Get
          
          $pipelineFolders = $testsFolders.objects | Where-Object { $_.object_type -eq "DIRECTORY" }
          
          Write-Host "‚úÖ Found $($pipelineFolders.Count) pipeline(s) to test:"
          foreach ($pf in $pipelineFolders) {
            $pipelineName = Split-Path $pf.path -Leaf
            Write-Host "  - $pipelineName"
          }
          
        } catch {
          Write-Host "‚ùå Error discovering test pipelines: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "Make sure RSCLP_TEST pipeline has deployed tests to /Workspace/Shared/Tests/pipelines/" -ForegroundColor Yellow
          exit 1
        }
        
        if ($pipelineFolders.Count -eq 0) {
          Write-Host "‚ö†Ô∏è  No test pipelines found. Skipping test execution." -ForegroundColor Yellow
          exit 0
        }
        
        $allTestsPassed = $true
        $testResults = @()
        
        # Run tests for each pipeline
        foreach ($pf in $pipelineFolders) {
          $pipelineName = Split-Path $pf.path -Leaf
          
          Write-Host "`n============================================================"
          Write-Host "üß™ Testing Pipeline: $pipelineName"
          Write-Host "============================================================"
          
          $runTestsNotebook = "/Workspace/Shared/Tests/pipelines/$pipelineName/utils/run_tests"
          
          # Check if run_tests notebook exists
          Write-Host "`nüìì Looking for test notebook at: $runTestsNotebook"
          
          try {
            $notebookPath = [uri]::EscapeDataString($runTestsNotebook)
            $notebookCheck = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.0/workspace/get-status?path=$notebookPath" `
              -Headers $headers `
              -Method Get
            
            Write-Host "  ‚úÖ Found test notebook"
            
          } catch {
            Write-Host "  ‚ö†Ô∏è  run_tests notebook not found at $runTestsNotebook" -ForegroundColor Yellow
            Write-Host "  Skipping tests for $pipelineName"
            $testResults += @{
              Pipeline = $pipelineName
              Status = "SKIPPED"
            }
            continue
          }
          
          # Run the test notebook
          Write-Host "`nüöÄ Running tests for $pipelineName..."
          
          try {
            $testJobBody = @{
              run_name = "Tests_${pipelineName}_${{ parameters.environment }}_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              tasks = @(
                @{
                  task_key = "run_tests"
                  notebook_task = @{
                    notebook_path = $runTestsNotebook
                  }
                  new_cluster = @{
                    spark_version = "13.3.x-scala2.12"
                    node_type_id = "Standard_DS3_v2"
                    num_workers = 1
                  }
                  timeout_seconds = 3600
                }
              )
            } | ConvertTo-Json -Depth 10
            
            $testRun = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.1/jobs/runs/submit" `
              -Headers $headers `
              -Method Post `
              -Body $testJobBody
            
            $testRunId = $testRun.run_id
            Write-Host "  ‚úÖ Test job submitted (Run ID: $testRunId)"
            Write-Host "  üìç Job URL: ${{ parameters.databricksHost }}/#job/$testRunId"
            
            # Wait for test completion
            $maxWaitTest = 60
            $startTimeTest = Get-Date
            $testCompleted = $false
            
            while (-not $testCompleted) {
              Start-Sleep -Seconds 15
              
              $testStatus = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.1/jobs/runs/get?run_id=$testRunId" `
                -Headers $headers `
                -Method Get
              
              $testState = $testStatus.state.life_cycle_state
              $resultState = if ($testStatus.state.result_state) { $testStatus.state.result_state } else { "RUNNING" }
              
              Write-Host "  ‚è≥ Status: $testState | Result: $resultState"
              
              if ($testState -eq "TERMINATED") {
                $testCompleted = $true
                
                if ($resultState -ne "SUCCESS") {
                  Write-Host "  ‚ùå Tests failed!" -ForegroundColor Red
                  
                  # Try to get error details
                  try {
                    $output = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.1/jobs/runs/get-output?run_id=$testRunId" `
                      -Headers $headers `
                      -Method Get
                    
                    if ($output.error) {
                      Write-Host "  Error: $($output.error)" -ForegroundColor Red
                    }
                    if ($output.metadata -and $output.metadata.state -and $output.metadata.state.state_message) {
                      Write-Host "  Message: $($output.metadata.state.state_message)" -ForegroundColor Red
                    }
                  } catch {
                    Write-Host "  Could not retrieve detailed error information"
                  }
                  
                  $allTestsPassed = $false
                  $testResults += @{
                    Pipeline = $pipelineName
                    Status = "FAILED"
                    RunId = $testRunId
                  }
                } else {
                  Write-Host "  ‚úÖ All tests passed!" -ForegroundColor Green
                  $testResults += @{
                    Pipeline = $pipelineName
                    Status = "PASSED"
                    RunId = $testRunId
                  }
                }
              }
              
              $elapsedTest = (Get-Date) - $startTimeTest
              if ($elapsedTest.TotalMinutes -gt $maxWaitTest) {
                Write-Host "  ‚ùå Test execution timed out after $maxWaitTest minutes" -ForegroundColor Red
                $allTestsPassed = $false
                $testResults += @{
                  Pipeline = $pipelineName
                  Status = "TIMEOUT"
                  RunId = $testRunId
                }
                break
              }
            }
            
          } catch {
            Write-Host "  ‚ùå Test execution failed: $($_.Exception.Message)" -ForegroundColor Red
            $allTestsPassed = $false
            $testResults += @{
              Pipeline = $pipelineName
              Status = "ERROR"
              Error = $_.Exception.Message
            }
          }
        }
        
        # Final Summary
        Write-Host "`n============================================================"
        Write-Host "  TEST EXECUTION SUMMARY - ${{ parameters.environment }}"
        Write-Host "============================================================"
        Write-Host "`nResults by Pipeline:"
        
        foreach ($result in $testResults) {
          $icon = switch ($result.Status) {
            "PASSED" { "‚úÖ"; break }
            "FAILED" { "‚ùå"; break }
            "TIMEOUT" { "‚è±Ô∏è"; break }
            "SKIPPED" { "‚è≠Ô∏è"; break }
            "ERROR" { "‚ùå"; break }
            default { "‚ùì" }
          }
          
          $color = if ($result.Status -eq "PASSED") { "Green" } elseif ($result.Status -eq "SKIPPED") { "Yellow" } else { "Red" }
          
          $message = "  $icon $($result.Pipeline): $($result.Status)"
          if ($result.RunId) {
            $message += " (Run ID: $($result.RunId))"
          }
          if ($result.Error) {
            $message += " - $($result.Error)"
          }
          
          Write-Host $message -ForegroundColor $color
        }
        
        Write-Host "`n============================================================"
        if ($allTestsPassed) {
          Write-Host "‚úÖ ALL TESTS PASSED SUCCESSFULLY!" -ForegroundColor Green
          Write-Host "============================================================"
          exit 0
        } else {
          Write-Host "‚ùå SOME TESTS FAILED!" -ForegroundColor Red
          Write-Host "============================================================"
          exit 1
        }
