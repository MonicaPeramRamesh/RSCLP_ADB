trigger:
  branches:
    include:
      - main

pool:
  name: Default
  demands:
    - agent.name -equals RSCLP_Agent

stages:
  # ===========================================
  # STAGE 1: DEPLOY TO DEV
  # ===========================================
  - stage: Deploy_Dev
    displayName: 'Deploy to DEV'
    variables:
      - group: dev-dlt-vars
    jobs:
      - job: DeployDev
        displayName: 'Deploy DLT & Notebooks to DEV'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'DEV'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)

  # ===========================================
  # STAGE 2: MANUAL APPROVAL FOR TEST
  # ===========================================
  - stage: Approval_Test
    displayName: 'Approval for TEST'
    dependsOn: Deploy_Dev
    jobs:
      - job: waitForValidation
        displayName: 'Wait for Manual Approval'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'peram.monica@outlook.com'
              instructions: |
                ✅ DEV deployment completed successfully.
                
                Please review and approve to deploy to TEST environment.
                
                Verify:
                - DLT pipelines deployed correctly
                - All transformations uploaded
              onTimeout: 'reject'

  # ===========================================
  # STAGE 3: DEPLOY TO TEST
  # ===========================================
  - stage: Deploy_Test
    displayName: 'Deploy to TEST'
    dependsOn: Approval_Test
    variables:
      - group: test-dlt-vars
    jobs:
      - job: DeployTest
        displayName: 'Deploy DLT & Notebooks to TEST'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'TEST'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)

  # ===========================================
  # STAGE 4: MANUAL APPROVAL FOR PROD
  # ===========================================
  - stage: Approval_Prod
    displayName: 'Approval for PROD'
    dependsOn: Deploy_Test
    jobs:
      - job: waitForValidation
        displayName: 'Wait for Manual Approval'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'peram.monica@outlook.com'
              instructions: |
                ✅ TEST deployment completed successfully.
                
                ⚠️  This is PRODUCTION deployment - proceed with caution!
                
                Please review and approve to deploy to PROD environment.
                
                Verify:
                - TEST deployment successful
                - Ready for production
              onTimeout: 'reject'

  # ===========================================
  # STAGE 5: DEPLOY TO PROD
  # ===========================================
  - stage: Deploy_Prod
    displayName: 'Deploy to PROD'
    dependsOn: Approval_Prod
    variables:
      - group: prod-dlt-vars
    jobs:
      - job: DeployProd
        displayName: 'Deploy DLT & Notebooks to PROD'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'PROD'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)
