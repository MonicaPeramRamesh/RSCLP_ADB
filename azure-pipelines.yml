trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '*/pipelines/*.json'
      - '*/transformations/**'

pool:
  name: 'Default'

variables:
  - group: test-dlt-vars

stages:
  - stage: Deploy
    jobs:
      - job: DeployDLT
        steps:
          - pwsh: |
              pip install databricks-cli
            displayName: 'Install Databricks CLI'

          - pwsh: |
              $env:DATABRICKS_HOST = "$(DATABRICKS_HOST)"
              $env:DATABRICKS_TOKEN = "$(DATABRICKS_TOKEN)"
              
              # Update pipeline configs
              Get-ChildItem -Path "." -Filter "*.json" -Recurse | Where-Object { $_.Directory.Name -eq "pipelines" } | ForEach-Object {
                python scripts/update_pipeline_json.py --file "$($_.FullName)" --catalog "$(DLT_CATALOG)" --schema "$(DLT_SCHEMA)" --secret_scope "$(DLT_SECRET_SCOPE)"
              }
              
              # Deploy files to workspace
              Get-ChildItem -Path "." -Directory | Where-Object { Test-Path "$($_.FullName)/pipelines" } | ForEach-Object {
                $project = $_.Name
                $reposPath = "/Repos/RSMAS_ADB/dlt/$project"
                
                databricks workspace mkdirs "$reposPath/transformations"
                Get-ChildItem "$($_.FullName)/transformations" -Filter "*.py" | ForEach-Object {
                  databricks workspace import "$($_.FullName)" "$reposPath/transformations/$($_.Name)" --language PYTHON --overwrite
                }
                
                Get-ChildItem "$($_.FullName)" -Filter "*.ipynb" | ForEach-Object {
                  databricks workspace import "$($_.FullName)" "$reposPath/$($_.BaseName)" --language PYTHON --format JUPYTER --overwrite
                }
              }
              
              # Deploy DLT pipelines
              Get-ChildItem -Path "." -Filter "*.json" -Recurse | Where-Object { $_.Directory.Name -eq "pipelines" } | ForEach-Object {
                $config = Get-Content $_.FullName -Raw | ConvertFrom-Json
                $existing = databricks pipelines get --pipeline-name "$($config.name)" 2>$null
                
                if ($LASTEXITCODE -eq 0) {
                  $id = ($existing | ConvertFrom-Json).pipeline_id
                  $config | ConvertTo-Json -Depth 10 -Compress | databricks pipelines update --pipeline-id "$id" --spec-json-input
                } else {
                  $config | ConvertTo-Json -Depth 10 -Compress | databricks pipelines create --spec-json-input
                }
              }
              
              Write-Host "âœ… Deployment complete"
            displayName: 'Deploy to Databricks'
            env:
              DATABRICKS_HOST: $(DATABRICKS_HOST)
              DATABRICKS_TOKEN: $(DATABRICKS_TOKEN)
